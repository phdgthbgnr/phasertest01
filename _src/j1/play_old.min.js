var playState={create:function(){this.directplayer=0;this.moveplayer=true;this.etoiles;this.vamps;this.tap1x=0;this.tap2x=0;this.tap1y=0;this.tap2y=0;this.fireTimer=0;this.bullet;this.bulletPool;this.curfire=false;this.notap1y=0;this.notap2y=0;this.delta=0;this.nbtap=0;this.humphSnd=game.add.audio("humph");this.proutchSnd=game.add.audio("proutch");this.pouetSnd=game.add.audio("pouet");this.rotSnd=game.add.audio("rot");this.blingSnd=game.add.audio("bling");var b;var e;var a;console.log("camera : width : "+game.camera.width+" height :"+game.camera.height);console.log("camera scale : "+game.camera.scale);console.log("camera view : "+game.camera.view);game.camera.width=game.width/window.devicePixelRatio;game.camera.height=game.height/window.devicePixelRatio;game.physics.setBoundsToWorld(true,true,true,true,true);this.middle=game.width/window.devicePixelRatio/2;var d=game.add.tileSprite(0,0,4096,1024,"bkg");d.smoothed=false;d.cacheAsBitmap=true;game.physics.arcade.gravity.y=600;e=game.add.tilemap("level1");this.stones=game.add.group();this.stones.enableBody=true;e.createFromObjects("ground",1,"stone",0,true,false,this.stones,Phaser.Sprite,true);this.stones.forEach(function(f){f.body.allowGravity=false;f.body.immovable=true;f.autoCull=true},this);this.etoiles=game.add.group();this.etoiles.enableBody=true;e.createFromObjects("etoiles",38,"etoile",0,true,false,this.etoiles,Phaser.Sprite,true);this.etoiles.callAll("animations.add","animations","spin",[0,1,2,3,4,5],12,true,true);this.etoiles.callAll("animations.play","animations","spin");this.etoiles.forEach(function(f){f.collid=false;f.body.allowGravity=false;f.body.immovable=true;f.name=f.key+f.z;f.autoCull=true},this);e.addTilesetImage("stuf","stuff");b=e.createLayer("stufs");a=game.add.group();e.createFromTiles([0,1,2,3,4,5,6],[],"stuff",b,a);b.renderSettings.enableScrollDelta=false;b.renderSettings.overdrawRatio=0.8;var c;if(localStorage.killedvamp==undefined){c={}}else{c=JSON.parse(localStorage.killedvamp)}c={};this.vamps=game.add.group();this.vamps.enableBody=true;e.createFromObjects("vampires",2,"vamp",0,true,false,this.vamps,Phaser.Sprite,true);this.vamps.callAll("animations.add","animations","idle",[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17],12,true,true);this.vamps.callAll("animations.add","animations","die",[18,19,20,21,22,23,24,25,26,27,28,29],12,false,true);this.vamps.callAll("animations.play","animations","idle");this.vamps.forEach(function(f){f.collid=false;f.body.allowGravity=false;f.body.immovable=true;f.name=f.key+f.z;if(c.hasOwnProperty(f.name)){f.kill()}f.autoCull=true},this);this.bulletPool=game.add.group();this.bulletPool.enableBody=true;this.bulletPool.createMultiple(30,"bullet");this.bulletPool.setAll("anchor.x",0.5);this.bulletPool.setAll("anchor.y",0.5);this.bulletPool.callAll("animations.add","animations","roll",[0,1,2,3,4,5,6,7],10,true);this.bulletPool.callAll("animations.add","animations","explode",[8,9,10,11],6,false);this.player=game.add.sprite(50,250,"captain");this.player.smoothed=false;this.physics.enable(this.player,Phaser.Physics.ARCADE);this.player.isdown=false;this.player.body.bounce.y=0.3;this.player.body.collideWorldBounds=true;this.player.body.setSize(36,64,22,0);this.player.body.gravity.y=600;this.player.animations.add("right",[0,1,2,3,4,5],12,true);this.player.animations.add("left",[6,7,8,9,10,11],12,true);this.player.animations.add("idler",[29,30,31,32,33,34],12,true);this.player.animations.add("idlel",[35,36,37,38,39,40],12,true);this.player.animations.add("explose",[12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28],15,true);this.player.animations.add("die",[65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94],20,true);this.player.animations.add("jumpr",[41,42,43,44,45,46],20,true);this.player.animations.add("jumpl",[47,48,49,50,51,52],20,true);this.player.animations.add("firer",[53,54,55,56,57],20,false);this.player.animations.add("firel",[59,60,61,62,63],20,false);game.camera.follow(this.player);this.player.events.onOutOfBounds.add(this.playerOutOfbounds,this);game.input.doubleTapRate=200;game.input.circle=66;game.input.mouse.enabled=true;game.input.maxPointers=1;game.input.touch.enabled=true;game.input.touch.start();game.input.onDown.add(this.touchDown,this);game.input.onUp.add(this.touchUp,this);game.input.onTap.add(this.tapOn,this);game.input.touch.callbackContext=this;game.input.touch.touchStartCallback=this.onTouchStart;game.input.touch.touchEndCallback=this.onTouchEnd},update:function(){game.physics.arcade.collide(this.player,this.stones,this.collidGroundCallback,this.processGroundCallback,this);game.physics.arcade.overlap(this.vamps,this.bulletPool,this.killvamps,null,this);game.physics.arcade.overlap(this.player,this.etoiles,this.collideEtoilesCallback,this.processEtoilesCallback,this)},Win:function(){},render:function(){},tapOn:function(a,b){console.log("onTap");if(b){console.log("doubleTap");this.directfire()}},onTouchStart:function(a){console.log("onTouchStart");this.tap1x=game.input.pointer1.positionDown.x},onTouchEnd:function(a){console.log("onTouchEnd");this.tap2x=game.input.pointer1.positionDown.x;if(game.input.pointer1.justPressed(200)){this.bullet=this.bulletPool.getFirstExists(false);this.delta=Math.abs(Math.round(this.tap1y-this.tap2y));if(this.tap1x<this.middle&&this.tap2x<this.middle&&this.nbtap%2===0&&this.delta<10){this.player.body.velocity.x=0;if(game.time.now>this.fireTimer&&this.bullet){this.player.animations.play("firel");this.player.events.onAnimationComplete.add(this.endFire,this)}this.nbtap=0}if(this.tap1x>this.middle&&this.tap2x>this.middle&&this.nbtap%2===0&&this.delta<10){this.player.body.velocity.x=0;if(game.time.now>this.fireTimer&&this.bullet){this.player.animations.play("firer");this.player.events.onAnimationComplete.add(this.endFire,this)}this.nbtap=0}}else{this.nbtap++}this.moveplayer=false;this.player.body.velocity.x=0;if(this.player.animations.currentAnim.name=="right"||this.player.animations.currentAnim.name=="left"||this.player.animations.currentAnim.name=="jumpr"||this.player.animations.currentAnim.name=="jumpl"){if(this.directplayer==1){this.player.animations.play("idler")}if(this.directplayer==-1){this.player.animations.play("idlel")}}},touchDown:function(a){this.moveplayer=true;console.log("touchDown");this.tap1y=game.input.pointer1.positionDown.y;console.log("isdown : "+this.player.isdown);console.log("moveplayer : "+this.moveplayer);console.log("velocity x : "+this.player.body.velocity.x);console.log("player x : "+this.player.x);console.log("worldx : "+game.input.worldX);console.log("currentAnim : "+this.player.animations.currentAnim.name);if(this.moveplayer){console.log("move");if(a.worldX>this.player.x&&this.player.animations.currentAnim.name!="firer"){this.directplayer=1;this.player.body.setSize(36,64,22,0);if(this.player.isdown){this.player.animations.play("right")}if(!this.player.isdown){this.player.animations.play("jumpr")}this.player.body.velocity.x=330}if(a.worldX<this.player.x&&this.player.animations.currentAnim.name!="firel"){this.directplayer=-1;this.player.body.setSize(36,64,8,0);if(this.player.isdown){this.player.animations.play("left")}if(!this.player.isdown){this.player.animations.play("jumpl")}this.player.body.velocity.x=-330}if(a.worldX>this.player.x&&this.player.animations.currentAnim.name=="firer"){this.directplayer=1;this.player.body.setSize(36,64,22,0);this.player.body.velocity.x=330;if(this.player.isdown){this.player.animations.play("right")}if(!this.player.isdown){this.player.animations.play("jumpr")}this.directfire()}if(a.worldX<this.player.x&&this.player.animations.currentAnim.name=="firel"){this.directplayer=-1;this.player.body.setSize(36,64,8,0);this.player.body.velocity.x=-330;if(this.player.isdown){this.player.animations.play("left")}if(!this.player.isdown){this.player.animations.play("jumpl")}this.directfire()}}},touchUp:function(a,b){console.log("touchUp");if(this.nbtap%2!=0){this.nbtap=0}this.tap2y=game.input.pointer1.position.y;if(this.player.isdown){if(this.tap1y-this.tap2y>30){this.player.body.velocity.y=-600;this.player.isdown=false;this.nbtap=0;this.humphSnd.play("",0,0.3,false,true)}}},endFire:function(b){var a=b.animations.currentAnim.name;var d=0;var c=0;if(a=="firer"||a=="jumpr"||a=="idler"||a=="right"){this.player.animations.play("idler");d=600;c=64}if(a=="firel"||a=="jumpl"||a=="idlel"||a=="left"){d=-600;this.player.animations.play("idlel")}if(this.bullet&&b.alive){this.bullet.reset(this.player.x+c,this.player.y+15);this.bullet.body.allowGravity=false;this.bullet.body.velocity.x=d;this.bullet.checkWorldBounds=true;this.bullet.outOfBoundsKill=true;this.bullet.body.immovable=true;this.bullet.animations.play("roll");this.bullet.lifespan=game.width/(d/500);this.fireTimer=game.time.now+300;b.events.onAnimationComplete.remove(this.endFire)}},directfire:function(){console.log("directfire");var a=this.player.animations.currentAnim.name;var c=0;var b=0;if(a=="firer"||a=="jumpr"||a=="idler"||a=="right"){c=600;b=64}if(a=="firel"||a=="jumpl"||a=="idlel"||a=="left"){c=-600}if(this.bullet){this.bullet.reset(this.player.x+b,this.player.y+15);this.bullet.body.allowGravity=false;this.bullet.body.velocity.x=c;this.bullet.checkWorldBounds=true;this.bullet.outOfBoundsKill=true;this.bullet.body.immovable=true;this.bullet.animations.play("roll");this.bullet.lifespan=game.width/(c/500);this.fireTimer=game.time.now+300}},playerOutOfbounds:function(a){console.log(a.x);console.log("outofbounds");console.log(game.width);if(a.x>game.width){game.world.setBounds(1280,0,game.width,game.height);game.camera.x=1280}},collidGroundCallback:function(a,b){if(!a.isdown&&a.alive){a.isdown=true;if(a.animations.currentAnim.name!="firer"&&a.animations.currentAnim.name!="firel"){if(this.moveplayer&&this.directplayer==1){this.player.animations.play("right")}if(this.moveplayer&&this.directplayer==-1){this.player.animations.play("left")}if(!this.moveplayer&&this.directplayer==1){this.player.animations.play("idler")}if(!this.moveplayer&&this.directplayer==-1){this.player.animations.play("idlel")}}}},processGroundCallback:function(){return true},killvamps:function(d,a){if(d.collid){return}var f;if(localStorage.killedvamp==undefined){f={};var e=JSON.stringify(f);localStorage.killedvamp=e}else{var c=localStorage.killedvamp;f=JSON.parse(c)}f[d.name]=1;var g=JSON.stringify(f);localStorage.killedvamp=g;d.collid=true;a.kill();d.events.onAnimationComplete.add(this.onkillvampscomplete,this);d.animations.play("die",12,false,true)},onkillvampscomplete:function(a){a.kill();a.events.destroy()},collideEtoilesCallback:function(b,a){a.kill();this.blingSnd.play()},processEtoilesCallback:function(){return true}};